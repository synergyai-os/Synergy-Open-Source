#!/bin/sh
# Design System Governance - Pre-Commit Validation

echo "üîç Validating design system compliance..."

# Run confidentiality check (blocks confidential information)
echo ""
echo "üîí Checking for confidential information..."
npm run check:confidentiality || {
	echo ""
	echo "‚ùå Confidential information detected!"
	echo "Fix confidentiality violations before committing."
	echo "Run: npm run sanitize:docs:apply"
	echo "See: dev-docs/2-areas/confidentiality-guidelines.md"
	exit 1
}

# Run ESLint (blocks hardcoded values)
npm run lint || {
	echo ""
	echo "‚ùå ESLint violations detected!"
	echo "Fix design system violations before committing."
	echo "See: dev-docs/2-areas/design/design-tokens.md"
	exit 1
}

# Additional check: Grep for hardcoded Tailwind in changed files
# Use process substitution to run while loop in main shell (avoids subshell issue)
validation_error=0
while IFS= read -r file; do
	# Check for [XXpx], [XXrem], [XX%], etc. in class attributes
	if git diff --cached "$file" | grep -E 'class="[^"]*\[([0-9]+(px|rem|%|vh|vw|em|ch))' > /dev/null; then
		echo ""
		echo "‚ùå Hardcoded Tailwind value detected in: $file"
		echo "   Pattern: class=\"...[value]\""
		echo ""
		echo "Replace with design token utility:"
		echo "   - min-h-[2.75rem] ‚Üí min-h-button (add to app.css)"
		echo "   - p-[12px] ‚Üí p-button-icon (already exists)"
		echo ""
		echo "See: dev-docs/2-areas/design/design-tokens.md"
		validation_error=1
	fi
done < <(git diff --cached --name-only | grep -E '\.(svelte|ts)$')

# Exit with error code if validation failed
if [ "$validation_error" -eq 1 ]; then
	exit 1
fi

echo "‚úÖ Design system validation passed!"

# Run quick design system audit (changed files only)
echo ""
echo "üîç Running quick design system audit..."
npm run audit:quick || {
	echo ""
	echo "‚ö†Ô∏è  Design system violations detected in changed files!"
	echo "Fix violations or run 'npm run audit:design-system' for full report."
	echo "See: AUDIT-REPORT.md for details"
	# Don't block commit, just warn (can be made blocking later)
}

# Run lint-staged (formatting)
npx lint-staged
