# E2E Tests Documentation

## Overview

End-to-end tests for SynergyOS using Playwright. Tests cover critical user flows including authentication, registration, password reset, and core app functionality.

## Test Coverage

### Authentication Flows

- **Login/Logout** (`auth-security.test.ts`)
  - Session management
  - CSRF protection
  - Unauthorized access prevention
  - Session tracking

- **Registration with Email Verification** (`auth-registration.test.ts`)
  - New user registration
  - Email verification with 6-digit PIN
  - Verification code expiry
  - Rate limiting on verification attempts
  - Password validation

- **Password Reset** (`auth-registration.test.ts`)
  - Forgot password flow
  - Reset link validation
  - Password strength validation
  - Token expiry handling

### Core Features

- **Inbox** (`inbox-workflow.spec.ts`)
- **Settings** (`settings-security.spec.ts`)
- **Quick Create** (`quick-create.spec.ts`)

## Setup

### 1. Environment Variables

Create `.env.test` in project root:

```bash
# Test user credentials (should exist in WorkOS)
TEST_USER_EMAIL=your-test-user@example.com
TEST_USER_PASSWORD=your-secure-password

# Enable test helper endpoints
E2E_TEST_MODE=true

# Optional: Custom base URL
BASE_URL=http://localhost:5173
```

### 2. Test User Setup

**CRITICAL**: Create a non-SSO test user in WorkOS to avoid SSO enforcement errors.

#### Why Non-SSO?

E2E tests use password authentication (`grant_type: 'password'`). If the test user is linked to an SSO connection in WorkOS, authentication will fail with `"sso_required"` error.

#### Steps to Create Test User:

1. **Go to WorkOS Dashboard**: https://dashboard.workos.com
2. **Navigate to**: User Management → Users
3. **Click "Create User"**
4. **Fill in details**:
   - Email: `e2e-test@synergyos-testing.com` (or similar non-SSO domain)
   - Password: Generate strong password (save in password manager)
   - First Name: `E2E`
   - Last Name: `Test`
   - Email Verified: ✅ **Check this box** (critical - skip email verification flow)
5. **IMPORTANT**: Do NOT link this user to any workspace with SSO connections
6. **Verify**: Email should show as "Verified" after creation

#### Update `.env.test`:

Use the credentials from Step 4 in your `.env.test` file:

```bash
TEST_USER_EMAIL=e2e-test@synergyos-testing.com
TEST_USER_PASSWORD=<your-secure-password>
```

#### Testing SSO Flows (Future):

For testing SSO authentication separately, create a dedicated test suite using [WorkOS Test Identity Provider](https://workos.com/docs/sso/test-sso/testing-with-the-test-identity-provider).

### 3. User Pattern Strategy

SynergyOS E2E tests use a systematic email pattern to avoid WorkOS SSO enforcement and enable clean test management.

#### Email Patterns

##### CI Test Users (Temporary)

These users are created during tests and can be auto-cleaned up:

- `randy+ci-reg-{timestamp}@synergyai.nl` - Registration flow tests
- `randy+ci-auth-{timestamp}@synergyai.nl` - Authentication tests
- `randy+ci-rate-{i}-{timestamp}@synergyai.nl` - Rate limiting tests

**Why**: Unique timestamps prevent conflicts, `ci-` prefix enables auto-cleanup

##### Worker Pool Users (Pre-created)

For parallel test execution with 5 workers:

- `randy+worker-0@synergyai.nl` - Worker 0
- `randy+worker-1@synergyai.nl` - Worker 1
- `randy+worker-2@synergyai.nl` - Worker 2
- `randy+worker-3@synergyai.nl` - Worker 3
- `randy+worker-4@synergyai.nl` - Worker 4

**Why**: Static emails reused across test runs, each worker gets unique account to prevent session conflicts

**Setup**: Add these credentials to `.env.test`:

```bash
# Worker 0 (generated by scripts/create-worker-users.ts)
WORKER_0_EMAIL=randy+worker-0@synergyai.nl
WORKER_0_PASSWORD=<generated-password>

# Worker 1
WORKER_1_EMAIL=randy+worker-1@synergyai.nl
WORKER_1_PASSWORD=<generated-password>

# Worker 2
WORKER_2_EMAIL=randy+worker-2@synergyai.nl
WORKER_2_PASSWORD=<generated-password>

# Worker 3
WORKER_3_EMAIL=randy+worker-3@synergyai.nl
WORKER_3_PASSWORD=<generated-password>

# Worker 4
WORKER_4_EMAIL=randy+worker-4@synergyai.nl
WORKER_4_PASSWORD=<generated-password>
```

**Creating Worker Users**:

```bash
# Run the worker user creation script (requires WORKOS_API_KEY in .env.local)
npx tsx scripts/create-worker-users.ts

# This will:
# 1. Create 5 pre-verified WorkOS users
# 2. Generate strong random passwords
# 3. Output credentials for .env.test
```

##### Static User (Long-lived)

For feature tests requiring established accounts:

- `randy+cicduser@synergyai.nl` - Main E2E test account (127+ sign-ins)
- `randy+cicduser2@synergyai.nl` - Secondary account

**Why**: Persistent data, realistic account state

##### Personal Users (Protected)

Never auto-cleanup:

- `randy+*@synergyai.nl` - User's personal test accounts

**Why**: Developers use these for manual testing

#### Why Not @example.com?

The `example.com` domain is linked to a WorkOS Test Organization with SSO enforcement, causing `sso_required` errors. Using `@synergyai.nl` (non-SSO domain) allows password authentication in tests.

#### Cleanup Policy (Phase 3)

Future cleanup script will:

- ✅ Delete users matching `randy+ci-*@synergyai.nl` older than 7 days
- ✅ Preserve worker pool, static users, and personal users

### 4. E2E Test Mode Configuration

E2E tests mock email sending to avoid hitting Resend API rate limits. Email skipping is controlled by the SvelteKit server environment, not Convex.

**How it works:**

- `E2E_TEST_MODE=true` is set in the SvelteKit server environment (via `.env.test` or npm script)
- SvelteKit server endpoints check this and pass `skipEmail: true` parameter to Convex actions
- Convex trusts the `skipEmail` parameter from SvelteKit (single source of truth)
- Verification codes are still generated and testable via `/test/get-verification-code`

**Important**: Do NOT set `E2E_TEST_MODE` in Convex deployment environment (`npx convex env set`). This would affect all requests, not just E2E tests. The SvelteKit server is responsible for determining test mode and passing it explicitly to Convex.

## Running Tests

### Local Development

```bash
# Run all E2E tests
npm run test:e2e

# Run specific test file
npm run test:e2e:auth         # Auth tests only
npm run test:e2e:inbox        # Inbox tests only
npm run test:e2e:settings     # Settings tests only

# Run with UI (interactive mode)
npx playwright test --ui

# Run in headed mode (see browser)
npx playwright test --headed

# Debug specific test
npx playwright test --debug e2e/auth-registration.test.ts
```

### CI/Local Pre-PR Validation

```bash
# Run all checks + tests (recommended before PR)
npm run ci:local

# This runs:
# - Type checking (npm run check)
# - Linting (npm run lint)
# - Unit tests (npm run test:unit:server)
# - Build (npm run build)
#
# Note: E2E tests are excluded from automation and must be run manually
```

### Manual Testing Only

**Important**: E2E tests are excluded from all automation (CI/CD, pre-commit hooks, etc.). They must be run manually when needed:

- E2E tests are NOT run automatically in GitHub Actions
- E2E tests are NOT run in pre-commit hooks
- E2E tests are NOT run in `npm run test` or `npm run ci:local`
- E2E tests can only be run manually using specific commands (see "Running Tests" above)

To run E2E tests manually:

- `npm run test:e2e` - Run all E2E tests
- `npm run test:e2e:auth` - Run auth tests only
- `npm run test:e2e:inbox` - Run inbox tests only
- `npm run test:e2e:settings` - Run settings tests only
- `npm run test:e2e:quick-create` - Run quick-create tests only

## Test Helper for Email Verification

### How It Works

The new registration flow requires email verification with a 6-digit PIN code. In E2E tests, we can't access real emails, so we use a test helper endpoint:

```typescript
// Get verification code in tests
const response = await request.get(
	'/test/get-verification-code?email=test@example.com&type=registration'
);
const { code } = await response.json();
```

### Security

The test helper endpoint (`/test/get-verification-code`) is secured:

✅ **Only enabled when `E2E_TEST_MODE=true`**
✅ **IP restricted to localhost only**
✅ **Returns 404 in production**
✅ **Requires email + type parameters**

### Usage in Tests

```typescript
test('should register with email verification', async ({ page, request }) => {
	// 1. Submit registration form
	await page.fill('input[type="email"]', 'test@example.com');
	await page.click('button[type="submit"]');

	// 2. Get verification code from test helper
	const codeResponse = await request.get(
		'/test/get-verification-code?email=test@example.com&type=registration'
	);
	const { code } = await codeResponse.json();

	// 3. Enter code in PIN input
	await page.fill('input', code);

	// 4. Verify registration succeeds
	await expect(page).toHaveURL(/\/inbox/);
});
```

## Authentication Setup

Tests use Playwright's [worker-scoped authentication](https://playwright.dev/docs/auth#authenticate-once-per-worker) pattern for parallel execution:

### Parallel Execution (5 Workers)

1. **Worker fixture** (`e2e/fixtures.ts`) - Runs once **per worker** (5 times total)
   - Worker 0 checks for `user-worker-0.json` → if missing, logs in as `randy+worker-0@synergyai.nl`
   - Worker 1 checks for `user-worker-1.json` → if missing, logs in as `randy+worker-1@synergyai.nl`
   - Worker 2 checks for `user-worker-2.json` → if missing, logs in as `randy+worker-2@synergyai.nl`
   - Worker 3 checks for `user-worker-3.json` → if missing, logs in as `randy+worker-3@synergyai.nl`
   - Worker 4 checks for `user-worker-4.json` → if missing, logs in as `randy+worker-4@synergyai.nl`
   - Authentication happens automatically before first test in each worker
   - Auth files are reused across test runs (no re-login required if files exist)

2. **Test execution** - Each worker uses its own authenticated session
   - Worker index determined by `test.info().parallelIndex` (0-4)
   - Custom fixture (`e2e/fixtures.ts`) provides worker-specific storage state
   - No session conflicts between parallel tests
   - **5x faster** test execution (~6 min vs ~30 min)

3. **Import pattern** - Tests import from fixtures, not `@playwright/test`:

   ```typescript
   // ✅ Import from custom fixtures
   import { test, expect } from './fixtures';

   test('authenticated test', async ({ page }) => {
   	// Worker-specific auth automatically applied
   	await page.goto('/settings');
   });
   ```

### Unauthenticated Tests

For testing unauthenticated flows (login, registration):

```typescript
test.use({ storageState: { cookies: [], origins: [] } });
```

## Writing New Tests

### Best Practices

1. **Use data-testid attributes** for selectors

   ```svelte
   <button data-testid="submit-btn">Submit</button>
   ```

   ```typescript
   await page.click('[data-testid="submit-btn"]');
   ```

2. **Generate unique test data**

   ```typescript
   const timestamp = Date.now();
   const testEmail = `test-${timestamp}@example.com`;
   ```

3. **Clean up test data** if needed
   - Delete test users after test
   - Reset state between tests

4. **Use explicit waits**

   ```typescript
   await expect(page).toHaveURL(/\/inbox/, { timeout: 10000 });
   ```

5. **Test error states**
   - Invalid input
   - Network errors
   - Rate limiting

### Test Structure

```typescript
test.describe('Feature Name', () => {
	// Setup/teardown if needed
	test.beforeEach(async ({ page }) => {
		// Setup
	});

	test('should do something', async ({ page }) => {
		// Arrange
		await page.goto('/page');

		// Act
		await page.click('button');

		// Assert
		await expect(page).toHaveURL(/\/result/);
	});
});
```

## Troubleshooting

### Tests Failing Locally

1. **Check environment variables**

   ```bash
   cat .env.test
   # Verify E2E_TEST_MODE=true
   ```

2. **Verify test user exists**
   - Log in manually with test credentials
   - Check WorkOS dashboard

3. **Check app is running**

   ```bash
   npm run dev
   # Should be accessible at http://localhost:5173
   ```

4. **Clear auth state**
   ```bash
   rm -rf e2e/.auth/user.json
   npm run test:e2e:setup  # Re-authenticate
   ```

### Test Helper Not Working

If `/test/get-verification-code` returns 404:

1. Check `E2E_TEST_MODE=true` in `.env.test`
2. Restart dev server
3. Verify endpoint exists: `curl http://localhost:5173/test/get-verification-code`

### SSO Required Error

If authentication fails with `"sso_required"` error:

```json
{
	"error": "sso_required",
	"email": "test@example.com",
	"error_description": "User must authenticate using one of the matching connections.",
	"connection_ids": ["conn_01K9KZHHQT3QQBBSZ4S2GAET7K"]
}
```

**Root Cause**: Test user is linked to an SSO connection in WorkOS.

**Solution**:

1. Create a new test user (see [Test User Setup](#2-test-user-setup))
2. Ensure the new user is NOT linked to any workspace with SSO connections
3. Use a different email domain (e.g., `e2e-test@synergyos-testing.com`)
4. Update `TEST_USER_EMAIL` in `.env.test`

**Why this happens**: WorkOS enforces SSO when a user is linked to an SSO-enabled workspace. E2E tests use password authentication (`grant_type: 'password'`), which is incompatible with SSO enforcement.

### Slow Tests

Playwright might be slow on first run (downloads browsers):

```bash
# Install browsers manually
npx playwright install
```

## Test Reports

After running tests:

```bash
# View HTML report
npx playwright show-report

# Report is automatically generated at:
# playwright-report/index.html
```

## CI Configuration

See `.github/workflows/` for CI setup:

- Environment variables must be set in GitHub Actions secrets
- Tests run on every PR
- Failed tests block merging

## Further Reading

- [Playwright Documentation](https://playwright.dev/)
- [Playwright Authentication](https://playwright.dev/docs/auth)
- [Playwright Best Practices](https://playwright.dev/docs/best-practices)
