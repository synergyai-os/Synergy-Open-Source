#!/bin/sh
# Design System Governance - Pre-Commit Validation

echo "üîç Validating design system compliance..."

# Run confidentiality check (blocks confidential information)
echo ""
echo "üîí Checking for confidential information..."
npm run check:confidentiality || {
	echo ""
	echo "‚ùå Confidential information detected!"
	echo "Fix confidentiality violations before committing."
	echo "Run: npm run sanitize:docs:apply"
	echo "See: dev-docs/2-areas/confidentiality-guidelines.md"
	exit 1
}

# Run ESLint (blocks hardcoded values)
npm run lint || {
	echo ""
	echo "‚ùå ESLint violations detected!"
	echo "Fix design system violations before committing."
	echo "See: dev-docs/2-areas/design/design-tokens.md"
	exit 1
}

# Additional check: Grep for hardcoded Tailwind in changed files
# Use a temporary file to avoid process substitution (works in /bin/sh)
validation_error=0
temp_file=$(mktemp)
git diff --cached --name-only | grep -E '\.(svelte|ts)$' > "$temp_file"
while IFS= read -r file; do
	# Check for [XXpx], [XXrem], [XX%], etc. in class attributes
	if git diff --cached "$file" | grep -E 'class="[^"]*\[([0-9]+(px|rem|%|vh|vw|em|ch))' > /dev/null; then
		echo ""
		echo "‚ùå Hardcoded Tailwind value detected in: $file"
		echo "   Pattern: class=\"...[value]\""
		echo ""
		echo "Replace with design token utility:"
		echo "   - min-h-[2.75rem] ‚Üí min-h-button (add to app.css)"
		echo "   - p-[12px] ‚Üí p-button-icon (already exists)"
		echo ""
		echo "See: dev-docs/2-areas/design/design-tokens.md"
		validation_error=1
	fi
done < "$temp_file"
rm -f "$temp_file"

# Exit with error code if validation failed
if [ "$validation_error" -eq 1 ]; then
	exit 1
fi

echo "‚úÖ Design system validation passed!"

# Recipe validation (SYOS-514)
echo ""
echo "üîç Validating CVA recipes..."
npm run recipes:validate || {
	echo ""
	echo "‚ùå Recipe validation failed!"
	echo "Recipe classes must exist in design system utilities."
	echo "See suggestions above and fix recipe files."
	exit 1
}

# Token build and validation (SYOS-477)
echo ""
echo "üî® Building tokens from DTCG..."
npm run tokens:build || {
	echo ""
	echo "‚ùå Token build failed!"
	echo "Fix token build errors before committing."
	exit 1
}

# Stage regenerated CSS files (if they changed)
echo ""
echo "üì¶ Staging regenerated CSS files..."
GENERATED_FILES="src/styles/tokens/*.css src/styles/utilities/*.css"
git add $GENERATED_FILES 2>/dev/null || true

# Validate semantic token references
echo ""
echo "üîç Validating semantic token references..."
npm run tokens:validate-semantic || {
	echo ""
	echo "‚ùå Semantic token validation failed!"
	echo "Semantic tokens must reference base tokens using {category.token} format."
	echo "Example: \"0.5rem\" ‚Üí \"{spacing.2}\""
	echo "See: dev-docs/2-areas/patterns/ci-cd.md#L2550"
	exit 1
}

# Check if generated CSS files were manually edited (still have unstaged changes after staging)
echo ""
echo "üîç Checking for manual edits to generated files..."
validation_error=0

# Check if any generated files have unstaged changes (indicates manual edit)
for file in $GENERATED_FILES; do
	if [ -f "$file" ]; then
		# Check if file has unstaged changes after build
		if ! git diff --quiet "$file"; then
			echo ""
			echo "‚ùå Generated file manually edited: $file"
			echo "   Generated CSS files must not be edited manually."
			echo "   Edit design-system.json instead, then run: npm run tokens:build"
			echo ""
			validation_error=1
		fi
	fi
done

# Exit with error code if validation failed
if [ "$validation_error" -eq 1 ]; then
	exit 1
fi

echo "‚úÖ Token validation passed!"

# Run quick design system audit (changed files only)
echo ""
echo "üîç Running quick design system audit..."
npm run audit:quick || {
	echo ""
	echo "‚ö†Ô∏è  Design system violations detected in changed files!"
	echo "Fix violations or run 'npm run audit:design-system' for full report."
	echo "See: AUDIT-REPORT.md for details"
	# Don't block commit, just warn (can be made blocking later)
}

# Run lint-staged (formatting)
npx lint-staged
