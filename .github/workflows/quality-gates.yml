name: Quality Gates

# Run on pull requests AND pushes to main (for Vercel Deployment Checks)
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    # Grant permissions for GitHub status updates and Vercel notifications
    permissions:
      contents: read
      statuses: write # Required for commit status updates
      checks: write # Required for check runs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --exclude-paths ai-content-blog,dev-docs/4-archive

      - name: Type check
        run: npm run check
        continue-on-error: true # TODO: Enable after fixing integration test errors (SYOS-72)

      - name: Lint
        run: npm run lint
        continue-on-error: true # TODO: Enable after fixing 483 linting errors (separate effort)

      - name: Svelte Validation
        run: npm run validate:svelte
        continue-on-error: true # Non-blocking initially (SYOS-445)

      - name: Design System Audit
        run: npm run audit:ci
        continue-on-error: true # Non-blocking initially (SYOS-406)

      - name: Token Usage Report
        run: npm run tokens:report -- --ci
        continue-on-error: true # Non-blocking initially (SYOS-436)

      - name: Token Audit (Orphaned Tokens)
        run: npm run tokens:audit -- --ci
        continue-on-error: true # Non-blocking initially (SYOS-538)

      - name: DTCG Format Validation
        run: npm run tokens:validate-dtcg
        continue-on-error: true # Non-blocking initially (SYOS-434)

      - name: Build Tokens
        run: npm run tokens:build

      - name: Semantic Token Validation
        run: npm run tokens:validate-semantic

      - name: Check Generated Files
        run: |
          # Check if generated CSS files were manually edited
          GENERATED_FILES="src/styles/tokens/*.css src/styles/utilities/*.css"
          MANUAL_EDIT_DETECTED=0

          for file in $GENERATED_FILES; do
            if [ -f "$file" ]; then
              # Check if file has unstaged changes after build (indicates manual edit)
              if ! git diff --quiet "$file"; then
                echo "❌ Generated file manually edited: $file"
                echo "   Generated CSS files must not be edited manually."
                echo "   Edit design-system.json instead, then run: npm run tokens:build"
                MANUAL_EDIT_DETECTED=1
              fi
            fi
          done

          if [ "$MANUAL_EDIT_DETECTED" -eq 1 ]; then
            echo ""
            echo "❌ Manual edits detected in generated CSS files!"
            echo "   Generated files must be auto-generated from design-system.json."
            echo "   See: dev-docs/2-areas/patterns/ci-cd.md#L2550"
            exit 1
          fi

          echo "✅ No manual edits detected in generated files"

      - name: Token Validation
        run: npm run tokens:validate

      - name: Build Storybook
        run: npm run build-storybook
        continue-on-error: true # Non-blocking initially (SYOS-433)

      - name: Storybook Visual Regression Tests
        run: |
          npx serve storybook-static -p 6006 -s &
          sleep 5
          npm run test:visual -- --ci || true
          pkill -f "serve storybook-static" || true
        continue-on-error: true # Non-blocking initially (SYOS-433)

      - name: Build verification
        run: npm run build
        env:
          # Convex configuration (both VITE_ and PUBLIC_ prefixes for SvelteKit compatibility)
          # Note: Placeholders work fine - build only checks syntax/imports, doesn't make API calls
          VITE_CONVEX_URL: ${{ secrets.CONVEX_URL || 'https://placeholder.convex.cloud' }}
          PUBLIC_CONVEX_URL: ${{ secrets.CONVEX_URL || 'https://placeholder.convex.cloud' }}
          # Session management (required for crypto module initialization)
          SYOS_SESSION_SECRET: ${{ secrets.SYOS_SESSION_SECRET || 'placeholder-secret-for-ci-build-verification-only-32chars' }}
          # WorkOS configuration (placeholders sufficient - build doesn't validate auth)
          # Production keys NOT needed here - they go in Vercel for actual deployments
          PUBLIC_WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID || 'placeholder-client-id' }}
          WORKOS_API_KEY: ${{ secrets.WORKOS_API_KEY || 'placeholder-api-key' }}
          WORKOS_REDIRECT_URI: ${{ secrets.WORKOS_REDIRECT_URI || 'http://localhost:5173/auth/callback' }}
        # Quality gate enabled - Build errors block merges

      - name: Quality check summary
        if: always()
        run: |
          echo "## Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ All quality checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some quality checks failed" >> $GITHUB_STEP_SUMMARY
          fi

      # Notify Vercel that quality checks passed (for Deployment Checks)
      # Status is determined by step success/failure, not by input parameter
      # Run regardless of previous step failures (if: always) so Vercel always receives status
      - name: Notify Vercel - Quality Checks
        if: always() # Run even if previous steps failed
        uses: 'vercel/repository-dispatch/actions/status@v1'
        with:
          # This name must match the check name in Vercel Dashboard → Settings → Git → Deployment Checks
          name: 'Quality Checks'
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Run tests (currently commented out as tests may not be stable)
  # Uncomment when test suite is reliable
  # tests:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Run unit tests
  #       run: npm run test:unit
  #
  #     - name: Run E2E tests
  #       run: npm run test:e2e
