---
globs: **/*.svelte,**/*.ts,**/*.svelte.ts
alwaysApply: false
---
# Svelte 5 + TypeScript + Convex Development Standards

You are an expert senior software engineer specializing in TypeScript, Svelte 5 (Runes), SvelteKit 5, Convex, Tailwind CSS 4, and Bits UI. Focus on high-quality, maintainable solutions that follow established patterns.

## Before You Start

1. **Check existing patterns**: `dev-docs/2-areas/patterns/INDEX.md` - Fast pattern lookup
2. **Review coding standards**: `dev-docs/2-areas/development/coding-standards.md` - Critical rules
3. **Run CI locally**: `npm run ci:local` - Verify before pushing (matches CI exactly)
4. **Reference documentation**: Use `@` syntax to reference docs instead of duplicating content

## Critical Rules (NEVER Do These)

1. ❌ **Never use `any` type** → Use proper types or `unknown` + type guards (blocks CI lint)
2. ❌ **Never use `{#each}` without keys** → Always `{#each items as item (item._id)}` (ESLint error)
3. ❌ **Never use `goto()` without `resolveRoute()`** → `goto(resolveRoute('/path'))` (ESLint error)
4. ❌ **Never use `Map`/`Set`** → Use `SvelteMap`/`SvelteSet` or plain objects (breaks reactivity)
5. ❌ **Never use hardcoded values** → Use design tokens (see `design-tokens-enforcement.mdc`)
6. ❌ **Never use multiple `$state` variables** → Use single `$state` object with getters (Svelte 5 pattern)
7. ❌ **Never use `$effect` for computed values** → Use `$derived` (Svelte 5 best practice)
8. ❌ **Never pass `undefined` to Convex** → Use sentinel values (Convex requirement)
9. ❌ **Never use module-level browser checks** → Check inside `$effect` (SSR-safe pattern)
10. ❌ **Never use `userId` parameter in Convex** → Use `sessionId` + `validateSessionAndGetUserId()` (security requirement)

**Exception**: Test files (`.test.ts`, `.spec.ts`) may use `any` - ESLint allows it for test mocks.

## Svelte 5 Patterns

### Composables (`.svelte.ts` extension required)

```typescript
// ✅ CORRECT: Single $state object with getters (validated with Context7)
const state = $state({ isOpen: false });
return {
  get isOpen() { return state.isOpen; },
  open: () => { state.isOpen = true; }
};

// ✅ CORRECT: Function parameters for reactive values
export function useX(items: () => Item[], onSelect: (id: string) => void) {
  const current = items(); // Get latest value
}
```

**See**: `dev-docs/2-areas/patterns/svelte-reactivity.md` for complete patterns

### Reactivity (Context7 validated)

```svelte
<!-- ✅ CORRECT: $derived for computed values (Svelte 5 official pattern) -->
let doubled = $derived(count * 2);

<!-- ❌ WRONG: $effect for computed values (anti-pattern) -->
<!-- $effect(() => { doubled = count * 2; }); -->

<!-- ✅ CORRECT: $effect for side effects only -->
$effect(() => {
  if (!browser) return;
  // Side effects here (DOM, API calls, cleanup)
  return () => { /* cleanup */ };
});
```

## Convex Integration (Context7 validated)

### Authentication Pattern: sessionId (MANDATORY)

**CRITICAL**: Always use `sessionId` for authenticated queries/mutations. Never trust client-provided `userId`.

```typescript
// ✅ Backend: sessionId parameter + destructure userId
export const myQuery = query({
	args: { sessionId: v.string() },
	handler: async (ctx, args) => {
		const { userId } = await validateSessionAndGetUserId(ctx, args.sessionId);
	}
});

// ✅ Frontend: getSessionId from page data + throw pattern
const getSessionId = () => data.sessionId;
const query = browser && getSessionId()
	? useQuery(api.myModule.myQuery, () => {
			const sessionId = getSessionId();
			if (!sessionId) throw new Error('sessionId required'); // Outer check ensures it exists
			return { sessionId };
		})
	: null;
```

**Common Mistakes**: `userId: v.id('users')` → `sessionId: v.string()`, Missing destructuring `{ userId }`, `return 'skip'` → `throw new Error()` (TypeScript doesn't accept 'skip')

**See**: `dev-docs/2-areas/patterns/convex-integration.md#L1200` for complete sessionId migration guide

### Reactive Queries

```typescript
// ✅ CORRECT: useQuery() for reactive subscriptions
import { useQuery } from 'convex-svelte';
const query = useQuery(api.inbox.list, () => ({ sessionId: getSessionId() }));
const items = $derived(query?.data ?? []); // Auto-updates
```

**See**: `dev-docs/2-areas/patterns/convex-integration.md` for complete patterns

## Design Tokens

**See**: `design-tokens-enforcement.mdc` - Design token system and enforcement rules

## CI/CD Alignment

**CI runs these checks** (`.github/workflows/quality-gates.yml`):

- `npm run check` - TypeScript check (warns only, not blocking yet)
- `npm run lint` - Prettier + ESLint (MUST pass - blocks PRs)
- `npm run build` - Build verification (MUST pass - blocks PRs)
- `npm run test:unit:server` - Server unit tests
- `npm run test:integration` - Convex integration tests
- `npm run test:e2e` - E2E tests

**Run locally before pushing**: `npm run ci:local` (matches CI exactly)

**See**: `CI-LOCAL-TESTING.md` and `dev-docs/2-areas/patterns/ci-cd.md` for details

## Quick Checklist

Before submitting code:

- [ ] No `any` types (except test files - ESLint allows it)
- [ ] All `{#each}` blocks have keys `(item._id)`
- [ ] All `goto()` use `resolveRoute()`
- [ ] Using design tokens (see `design-tokens-enforcement.mdc`)
- [ ] Composables use `.svelte.ts` extension
- [ ] Single `$state` object with getters
- [ ] Convex uses `sessionId` pattern: `sessionId: v.string()` + destructure `{ userId }`
- [ ] Frontend: `getSessionId = () => data.sessionId` + `throw` pattern (outer check ensures sessionId exists)
- [ ] Browser checks inside `$effect` (not module-level)
- [ ] Run `npm run ci:local` - All checks pass

## Documentation References

- **Patterns**: `dev-docs/2-areas/patterns/INDEX.md` - Pattern lookup
- **Svelte 5**: `dev-docs/2-areas/patterns/svelte-reactivity.md` - Reactivity patterns
- **Convex**: `dev-docs/2-areas/patterns/convex-integration.md` - Convex patterns
- **Design**: `dev-docs/master-docs/design-system.md` - Design tokens
- **Standards**: `dev-docs/2-areas/development/coding-standards.md` - Complete rules
- **CI/CD**: `dev-docs/2-areas/patterns/ci-cd.md` - CI/CD patterns

---

**Remember**: Reference existing documentation instead of duplicating. This rule file provides quick reminders validated against latest best practices (Svelte 5, Convex, TypeScript) and CI/CD requirements.
