name: Quality Gates

# Run on pull requests AND pushes to main (for Vercel Deployment Checks)
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    # Grant permissions for GitHub status updates and Vercel notifications
    permissions:
      contents: read
      statuses: write # Required for commit status updates
      checks: write # Required for check runs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Core invariants (critical, dev)
        run: npm run ci:invariants
        continue-on-error: true # Non-blocking: Convex auth may need configuration
        env:
          CONVEX_URL: ${{ secrets.TEST_CONVEX_URL }}
          # Use dev deploy key if available, fallback to production key
          CONVEX_AUTH_TOKEN: ${{ secrets.CONVEX_DEPLOY_KEY_DEV || secrets.CONVEX_DEPLOY_KEY }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY_DEV || secrets.CONVEX_DEPLOY_KEY }}

      - name: Auth guard (Convex)
        run: npm run guard:auth

      - name: Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --exclude-paths .trufflehogignore
        continue-on-error: true # Non-blocking: Secret scan failures don't block deployment
        # Note: TruffleHog may fail on commit ref issues - that's OK, we'll catch real secrets in code review

      - name: Type check
        run: npm run check
        continue-on-error: true # TODO: Enable after fixing integration test errors (SYOS-72)

      - name: Build tokens
        run: npm run tokens:build

      - name: Validate transforms
        run: npm run test:transforms
        continue-on-error: true # Non-blocking: Tests not at quality level to trust yet

      - name: Validate documentation
        run: npm run validate:docs
        continue-on-error: true # Non-blocking: Quality check, not critical for deployment

      - name: Validate recipes
        run: npm run recipes:validate
        continue-on-error: true # Non-blocking: Quality check, not critical for deployment

      - name: Lint
        run: npm run lint
        continue-on-error: true # TODO: Enable after fixing 483 linting errors (separate effort)

      - name: Svelte Validation
        run: npm run validate:svelte
        continue-on-error: true # Non-blocking initially (SYOS-445)

      - name: Design System Audit
        run: npm run audit:ci
        continue-on-error: true # Non-blocking initially (SYOS-406)

      - name: Token Usage Report
        run: npm run tokens:report -- --ci
        continue-on-error: true # Non-blocking initially (SYOS-436)

      - name: Token Audit (Orphaned Tokens)
        run: npm run tokens:audit -- --ci
        continue-on-error: true # Non-blocking initially (SYOS-538)

      - name: DTCG Format Validation
        run: npm run tokens:validate-dtcg
        continue-on-error: true # Non-blocking initially (SYOS-434)

      - name: Build Tokens
        run: npm run tokens:build

      - name: Semantic Token Validation
        run: npm run tokens:validate-semantic

      - name: Check for Direct Modifications to Auto-Generated Files
        run: |
          # Check for direct modifications to auto-generated files
          # Protected paths (auto-generated files)
          PROTECTED_PATTERNS="src/styles/tokens/|src/styles/utilities/"

          # Source files (if these change, regenerated files are expected to change)
          SOURCE_FILES="design-tokens-base.json|design-tokens-semantic.json"

          # Get list of changed files in this PR
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA...$HEAD_SHA)
          else
            # For pushes, compare against previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD)
          fi

          # Check for protected files
          PROTECTED_CHANGES=$(echo "$CHANGED_FILES" | grep -E "$PROTECTED_PATTERNS" || true)

          if [ -n "$PROTECTED_CHANGES" ]; then
            # Check if source files also changed
            SOURCE_CHANGES=$(echo "$CHANGED_FILES" | grep -E "$SOURCE_FILES" || true)
            
            # If protected files changed but source files didn't, that's suspicious
            if [ -z "$SOURCE_CHANGES" ]; then
              echo "❌ ERROR: Direct modifications to auto-generated files detected"
              echo ""
              echo "These files are auto-generated and should not be modified directly:"
              echo "$PROTECTED_CHANGES"
              echo ""
              echo "To modify these files:"
              echo "  1. Edit design-tokens-base.json or design-tokens-semantic.json"
              echo "  2. Run: npm run tokens:build"
              echo "  3. Commit the regenerated files"
              echo ""
              echo "See: dev-docs/master-docs/design-system.md Section 1.5 (AI Development Guardrails)"
              exit 1
            else
              echo "✅ Auto-generated files changed alongside source files (legitimate regeneration)"
            fi
          else
            echo "✅ No direct modifications to auto-generated files"
          fi

      - name: Token Validation
        run: npm run tokens:validate

      - name: Build Storybook
        run: npm run build-storybook
        continue-on-error: true # Non-blocking initially (SYOS-433)

      - name: Storybook Visual Regression Tests
        run: |
          npx serve storybook-static -p 6006 -s &
          sleep 5
          npm run test:visual -- --ci || true
          pkill -f "serve storybook-static" || true
        continue-on-error: true # Non-blocking initially (SYOS-433)

      - name: Build verification
        run: npm run build
        env:
          # Convex configuration (both VITE_ and PUBLIC_ prefixes for SvelteKit compatibility)
          # Note: Placeholders work fine - build only checks syntax/imports, doesn't make API calls
          VITE_CONVEX_URL: ${{ secrets.CONVEX_URL || 'https://placeholder.convex.cloud' }}
          PUBLIC_CONVEX_URL: ${{ secrets.CONVEX_URL || 'https://placeholder.convex.cloud' }}
          # Session management (required for crypto module initialization)
          SYOS_SESSION_SECRET: ${{ secrets.SYOS_SESSION_SECRET || 'placeholder-secret-for-ci-build-verification-only-32chars' }}
          # WorkOS configuration (placeholders sufficient - build doesn't validate auth)
          # Production keys NOT needed here - they go in Vercel for actual deployments
          PUBLIC_WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID || 'placeholder-client-id' }}
          WORKOS_API_KEY: ${{ secrets.WORKOS_API_KEY || 'placeholder-api-key' }}
          WORKOS_REDIRECT_URI: ${{ secrets.WORKOS_REDIRECT_URI || 'http://localhost:5173/auth/callback' }}
        # Quality gate enabled - Build errors block merges

      - name: Quality check summary
        if: always()
        run: |
          echo "## Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Note: Some checks may show warnings but are non-blocking for deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == 'success' ]; then
            echo "✅ All quality checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Some quality checks had issues (non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo "✅ Deployment workflow will still proceed" >> $GITHUB_STEP_SUMMARY
          fi

      # Notify Vercel that quality checks passed (for Deployment Checks)
      # Status is determined by step success/failure, not by input parameter
      # Run regardless of previous step failures (if: always) so Vercel always receives status
      - name: Notify Vercel - Quality Checks
        if: always() # Run even if previous steps failed
        continue-on-error: true # Don't fail job if Vercel notification fails
        uses: 'vercel/repository-dispatch/actions/status@v1'
        with:
          # This name must match the check name in Vercel Dashboard → Settings → Git → Deployment Checks
          name: 'Quality Checks'
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Run tests (currently commented out as tests may not be stable)
  # Uncomment when test suite is reliable
  # tests:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '22'
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Run unit tests
  #       run: npm run test:unit
  #
  #     - name: Run E2E tests
  #       run: npm run test:e2e
