#!/bin/sh
# Design System Governance - Pre-Commit Validation

echo "üîç Validating design system compliance..."

# Run confidentiality check (blocks confidential information)
echo ""
echo "üîí Checking for confidential information..."
npm run check:confidentiality || {
	echo ""
	echo "‚ùå Confidential information detected!"
	echo "Fix confidentiality violations before committing."
	echo "Run: npm run sanitize:docs:apply"
	echo "See: dev-docs/2-areas/confidentiality-guidelines.md"
	exit 1
}

# Run ESLint (blocks hardcoded values)
npm run lint || {
	echo ""
	echo "‚ùå ESLint violations detected!"
	echo "Fix design system violations before committing."
	echo "See: dev-docs/2-areas/design/design-tokens.md"
	exit 1
}

# Additional check: Grep for hardcoded Tailwind in changed files
# Use a temporary file to avoid process substitution (works in /bin/sh)
validation_error=0
temp_file=$(mktemp)
git diff --cached --name-only | grep -E '\.(svelte|ts)$' > "$temp_file"
while IFS= read -r file; do
	# Check for [XXpx], [XXrem], [XX%], etc. in class attributes
	if git diff --cached "$file" | grep -E 'class="[^"]*\[([0-9]+(px|rem|%|vh|vw|em|ch))' > /dev/null; then
		echo ""
		echo "‚ùå Hardcoded Tailwind value detected in: $file"
		echo "   Pattern: class=\"...[value]\""
		echo ""
		echo "Replace with design token utility:"
		echo "   - min-h-[2.75rem] ‚Üí min-h-button (add to app.css)"
		echo "   - p-[12px] ‚Üí p-button-icon (already exists)"
		echo ""
		echo "See: dev-docs/2-areas/design/design-tokens.md"
		validation_error=1
	fi
done < "$temp_file"
rm -f "$temp_file"

# Exit with error code if validation failed
if [ "$validation_error" -eq 1 ]; then
	exit 1
fi

echo "‚úÖ Design system validation passed!"

# Recipe validation (SYOS-514)
echo ""
echo "üîç Validating CVA recipes..."
npm run recipes:validate || {
	echo ""
	echo "‚ùå Recipe validation failed!"
	echo "Recipe classes must exist in design system utilities."
	echo "See suggestions above and fix recipe files."
	exit 1
}

# Token build and validation (SYOS-477)
echo ""
echo "üî® Building tokens from DTCG..."
npm run tokens:build || {
	echo ""
	echo "‚ùå Token build failed!"
	echo "Fix token build errors before committing."
	exit 1
}

# Stage regenerated CSS files (if they changed)
echo ""
echo "üì¶ Staging regenerated CSS files..."
GENERATED_FILES="src/styles/tokens/*.css src/styles/utilities/*.css"
git add $GENERATED_FILES 2>/dev/null || true

# Validate semantic token references
echo ""
echo "üîç Validating semantic token references..."
npm run tokens:validate-semantic || {
	echo ""
	echo "‚ùå Semantic token validation failed!"
	echo "Semantic tokens must reference base tokens using {category.token} format."
	echo "Example: \"0.5rem\" ‚Üí \"{spacing.2}\""
	echo "See: dev-docs/2-areas/patterns/ci-cd.md#L2550"
	exit 1
}

# Check for deprecated token usage (SYOS-538)
echo ""
echo "üîç Checking for deprecated token usage..."
npx tsx scripts/validate-tokens.ts --fail-on-deprecated || {
	echo ""
	echo "‚ùå Deprecated tokens detected in codebase!"
	echo "Migrate to replacement tokens before committing."
	echo "See: dev-docs/master-docs/design-system.md Section 12.4"
	exit 1
}

# Check for direct modifications to auto-generated files
echo ""
echo "üîç Checking for direct modifications to auto-generated files..."
validation_error=0

# Check if any protected files are being committed
PROTECTED_CHANGED=0
if git diff --cached --name-only | grep -q "^src/styles/tokens/"; then
	PROTECTED_CHANGED=1
fi
if git diff --cached --name-only | grep -q "^src/styles/utilities/"; then
	PROTECTED_CHANGED=1
fi

# If protected files changed, check if source files also changed
if [ "$PROTECTED_CHANGED" -eq 1 ]; then
	SOURCE_CHANGED=0
	if git diff --cached --name-only | grep -q "^design-tokens-base.json"; then
		SOURCE_CHANGED=1
	fi
	if git diff --cached --name-only | grep -q "^design-tokens-semantic.json"; then
		SOURCE_CHANGED=1
	fi

	# If protected files changed but source files didn't, that's suspicious
	if [ "$SOURCE_CHANGED" -eq 0 ]; then
		echo ""
		echo "‚ùå ERROR: Attempting to commit changes to auto-generated files"
		echo ""
		echo "The following files are auto-generated and should not be modified directly:"
		git diff --cached --name-only | grep -E "^src/styles/(tokens|utilities)/"
		echo ""
		echo "To modify these files:"
		echo "  1. Edit design-tokens-base.json or design-tokens-semantic.json"
		echo "  2. Run: npm run tokens:build"
		echo "  3. The files will be regenerated"
		echo ""
		echo "See: dev-docs/master-docs/design-system.md Section 1.5 (AI Development Guardrails)"
		validation_error=1
	fi
fi

# Exit with error code if validation failed
if [ "$validation_error" -eq 1 ]; then
	exit 1
fi

echo "‚úÖ Token validation passed!"

# Run quick design system audit (changed files only)
echo ""
echo "üîç Running quick design system audit..."
npm run audit:quick || {
	echo ""
	echo "‚ö†Ô∏è  Design system violations detected in changed files!"
	echo "Fix violations or run 'npm run audit:design-system' for full report."
	echo "See: AUDIT-REPORT.md for details"
	# Don't block commit, just warn (can be made blocking later)
}

# Documentation validation (SYOS-558)
echo ""
echo "üîç Validating documentation utility names..."
npm run validate:docs || {
	echo ""
	echo "‚ö†Ô∏è  Documentation validation failed!"
	echo "Documentation contains invalid utility names."
	echo "Run 'npm run fix:docs' to fix automatically, or fix manually."
	echo "See: scripts/tests/utility-mapping.json for mappings"
	echo ""
	echo "‚ö†Ô∏è  WARNING: This will block commits once all violations are fixed."
	echo "   For now, continuing with commit (non-blocking mode)..."
	# TODO: Change to exit 1 once all violations are fixed
}

# Run lint-staged (formatting)
npx lint-staged
